<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="utf-8" />
    <title>Daniel Sebban le blog</title>
    <link rel="shortcut icon" type="image/png" href="http://dsebban.github.io/blog/fr/favicon.png">
    <link rel="shortcut icon" type="image/x-icon" href="http://dsebban.github.io/blog/fr/favicon.ico">
    <link href="http://dsebban.github.io/blog/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Daniel Sebban le blog Full Atom Feed" />
    <link rel="stylesheet" href="http://dsebban.github.io/blog/fr/theme/css/screen.css" type="text/css" />
    <link rel="stylesheet" href="http://dsebban.github.io/blog/fr/theme/css/pygments.css" type="text/css" />
    <link rel="stylesheet" href="http://dsebban.github.io/blog/fr/theme/css/print.css" type="text/css" media="print" />
    <meta name="generator" content="Pelican" />
</head>
<body>
    <header>
        <nav>
                <li class="selected"><a href="http://dsebban.github.io/blog/fr">Home</a></li>
                <li><a href="http://dsebban.github.io/blog/fr/pages/about.html">About</a></li>
                <li><a href="http://dsebban.github.io/blog/fr/archives.html">Archives</a></li>
        </nav>
        <div class="header_box">
            <h1><a href="http://dsebban.github.io/blog/fr">Daniel Sebban le blog</a></h1>
        </div>
    </header>
    <div id="wrapper">
        <div id="content">
            <h4 class="date">Jul 20, 2015</h4>
            <article class="post">
<h2 class="title">
                    <a href="http://dsebban.github.io/blog/fr/2015/rxjava-in-action-with-live-financial-market-data-from-ib-part-1.html" rel="bookmark" title="Permanent Link to &quot;RxJava in Action with live financial market data from IB (Part 1)&quot;">RxJava in Action with live financial market data from IB (Part 1)</a>
                </h2>

                <p>Dans un de mes récents projets j'ai automatisé une stratégie de trading en utilisant L'API Java <a href="https://www.interactivebrokers.com/en/?f=%2Fen%2Fsoftware%2Fibapi.php&amp;ns=T">Iteractive Brokers</a>,
Le framework qui s'accorde avec merveille pour travailler avec des flux de donnes  en temps reel est <a href="https://github.com/ReactiveX/RxJava">RxJava</a>.
Lire la doc et les exemples de RxJava peu etre assez abstrait, voici un exemple concret de comment integrer ces deux technologies ensembles
  - Connecter les donnees du marche avec la classe marketDataObservable de RxJava
  - Agréger les  donnees temp reel en bar d'une minute , utilisant les operateurs groupBy, flatmap et buffer.</p>
<h3>1. Connecter les donnees du marche avec la classe marketDataObservable</h3>
<div class="highlight"><pre> <span class="kd">public</span> <span class="kt">void</span> <span class="nf">subscribeRealTimeData</span><span class="o">(</span><span class="n">Instrument</span> <span class="n">instrument</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">controller</span><span class="o">.</span><span class="na">reqTopMktData</span><span class="o">(</span><span class="n">instrument</span><span class="o">.</span><span class="na">ibContract</span><span class="o">,</span> <span class="s">&quot;232&quot;</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="k">new</span> <span class="n">ApiController</span><span class="o">.</span><span class="na">ITopMktDataHandler</span><span class="o">()</span>
    <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">tickPrice</span><span class="o">(</span><span class="n">TickType</span> <span class="n">tickType</span><span class="o">,</span> <span class="kt">double</span> <span class="n">price</span><span class="o">,</span> <span class="kt">int</span> <span class="n">canAutoExecute</span><span class="o">)</span> <span class="o">{</span>

            <span class="k">if</span> <span class="o">(</span><span class="n">tickType</span> <span class="o">==</span> <span class="n">TickType</span><span class="o">.</span><span class="na">ASK</span><span class="o">)</span>
            <span class="o">{</span>
                <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&quot;IB tick &quot;</span> <span class="o">+</span> <span class="k">new</span> <span class="n">Date</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot; price &quot;</span> <span class="o">+</span> <span class="n">price</span><span class="o">);</span>
                <span class="n">LivePriceEvent</span> <span class="n">priceEvent</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LivePriceEvent</span><span class="o">(</span><span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">(),</span> <span class="n">instrument</span><span class="o">,</span> <span class="k">new</span> <span class="n">BigDecimal</span><span class="o">(</span><span class="n">price</span><span class="o">).</span><span class="na">setScale</span><span class="o">(</span><span class="mi">3</span><span class="o">,</span> <span class="n">RoundingMode</span><span class="o">.</span><span class="na">UP</span><span class="o">));</span>
                <span class="n">marketDataObservable</span><span class="o">.</span><span class="na">push</span><span class="o">(</span><span class="n">priceEvent</span><span class="o">);</span>
            <span class="o">}</span>

        <span class="o">}</span>
</pre></div>


<p>Chaque fois qu'un prix arrive depuis IB , il serra pousser dans notre Observable,On peut maintenant travailler avec les donnees et les utiliser les operateurs de RxJAva</p>
<h3>2. Agréger les donnes temps reel en bars d'1-minute</h3>
<div class="highlight"><pre><span class="kd">public</span> <span class="kt">void</span> <span class="nf">aggregateLiveMinuteBar</span><span class="o">()</span> <span class="o">{</span>

    <span class="n">observable</span><span class="o">().</span>
            <span class="n">ofType</span><span class="o">(</span><span class="n">LivePriceEvent</span><span class="o">.</span><span class="na">class</span><span class="o">).</span> <span class="c1">//donne moi seulement les donnees temps reel</span>
            <span class="n">groupBy</span><span class="o">(</span><span class="nl">LivePriceEvent:</span><span class="o">:</span><span class="n">getInstrument</span><span class="o">).</span> <span class="c1">// groupe par instrument i.e AAPL, GOOG</span>
            <span class="n">flatMap</span><span class="o">(</span><span class="n">grouped</span> <span class="o">-&gt;</span> <span class="n">grouped</span><span class="o">.</span><span class="na">buffer</span><span class="o">(</span><span class="mi">2</span><span class="o">,</span> <span class="mi">1</span><span class="o">)).</span> <span class="c1">// prend chaque 2 prix consecutif</span>
            <span class="n">subscribe</span><span class="o">(</span><span class="n">listOf2</span> <span class="o">-&gt;</span> <span class="o">{</span>
                <span class="n">LivePriceEvent</span> <span class="n">lastEvent</span> <span class="o">=</span> <span class="n">listOf2</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
                <span class="kt">int</span> <span class="n">lastMinute</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DateTime</span><span class="o">(</span><span class="n">lastEvent</span><span class="o">.</span><span class="na">getCreateTimestamp</span><span class="o">()).</span><span class="na">minuteOfHour</span><span class="o">().</span><span class="na">get</span><span class="o">();</span>
                <span class="kt">int</span> <span class="n">currentMinute</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DateTime</span><span class="o">(</span><span class="n">listOf2</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">1</span><span class="o">).</span><span class="na">getCreateTimestamp</span><span class="o">()).</span><span class="na">minuteOfHour</span><span class="o">().</span><span class="na">get</span><span class="o">();</span>
        <span class="c1">///quand la minute est passe , on pousse le resultat dans l observable pour que la minute-bar soit disponible pour d&#39;autres souscripteurs</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">lastMinute</span> <span class="o">!=</span> <span class="n">currentMinute</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">push</span><span class="o">(</span><span class="k">new</span> <span class="n">LiveBarEvent</span><span class="o">(</span><span class="n">TimeUnit</span><span class="o">.</span><span class="na">MINUTES</span><span class="o">,</span> <span class="n">lastEvent</span><span class="o">.</span><span class="na">createTimestamp</span><span class="o">,</span> <span class="n">lastEvent</span><span class="o">.</span><span class="na">getInstrument</span><span class="o">(),</span> <span class="n">lastEvent</span><span class="o">.</span><span class="na">getPrice</span><span class="o">()));</span>
                <span class="o">}</span>

    <span class="o">});</span>


<span class="o">}</span>
</pre></div>


<h3>3. Executer  l’application  sur votre machine avec un flux demo d'IB</h3>
<p>suivre les instructions sur mon github <a href="https://github.com/dsebban/blog-post-1">github</a></p>
<div class="highlight"><pre><span class="nv">$ </span>git clone <span class="o">[</span>https://github.com/dsebban/blog-post-1<span class="o">]</span> rx-ib
<span class="nv">$ </span><span class="nb">cd </span>rx-ib
<span class="nv">$ </span>mvn package
<span class="nv">$ </span>foreman start
</pre></div>


<p>vous devriez voir</p>
<div class="highlight"><pre>daniel@daniel-desktop:~/Projects/dice_bot/blog-post-1<span class="nv">$ </span>foreman start

16:22:37 ib.1   | started with pid 29935
16:22:37 app.1  | started with pid 29937
16:22:47 app.1  | Server Version:76
16:22:47 app.1  | TWS Time at connection:20150717 16:22:44 IST
16:22:47 app.1  | Jul 17, 2015 4:22:47 PM daniels.reactive.blog.InteractiveBrokersFeed<span class="nv">$2</span> connectedTags: pelican, publishing
Slug: my-super-post
16:22:47 app.1  | INFO: connected
16:22:48 app.1  | Jul 17, 2015 4:22:48 PM daniels.reactive.blog.InteractiveBrokersFeed<span class="nv">$2</span> message
16:22:48 app.1  | SEVERE: id -1 <span class="nv">errocode</span> <span class="o">=</span> 2119msg Market data farm is connecting:ibdemo
16:22:48 app.1  | Jul 17, 2015 4:22:48 PM daniels.reactive.blog.InteractiveBrokersFeed<span class="nv">$2</span> message
16:22:48 app.1  | SEVERE: id -1 <span class="nv">errocode</span> <span class="o">=</span> 2104msg Market data farm connection is OK:ibdemo
16:22:48 app.1  | Jul 17, 2015 4:22:48 PM daniels.reactive.blog.InteractiveBrokersFeed<span class="nv">$1</span> tickPrice
16:22:48 app.1  | INFO: IB tick Fri Jul 17 16:22:48 IDT 2015 price 122.09
16:22:48 app.1  | Jul 17, 2015 4:22:48 PM daniels.reactive.blog.InteractiveBrokersFeed<span class="nv">$1</span> tickPrice
16:22:48 app.1  | INFO: IB tick Fri Jul 17 16:22:48 IDT 2015 price 122.08
16:22:52 app.1  | Jul 17, 2015 4:22:52 PM daniels.reactive.blog.InteractiveBrokersFeed<span class="nv">$1</span> tickPrice
16:22:52 app.1  | INFO: IB tick Fri Jul 17 16:22:52 IDT 2015 price 122.09
16:22:58 app.1  | Jul 17, 2015 4:22:58 PM daniels.reactive.blog.InteractiveBrokersFeed<span class="nv">$1</span> tickPrice
16:22:58 app.1  | INFO: IB tick Fri Jul 17 16:22:58 IDT 2015 price 122.08
16:23:00 app.1  | Jul 17, 2015 4:23:00 PM daniels.reactive.blog.InteractiveBrokersFeed<span class="nv">$1</span> tickPrice
16:23:00 app.1  | INFO: IB tick Fri Jul 17 16:23:00 IDT 2015 price 122.09
16:23:00 app.1  | Jul 17, 2015 4:23:00 PM daniels.reactive.blog.Main lambda<span class="nv">$main$0</span>
16:23:00 app.1  | INFO: <span class="nv">minute</span> <span class="o">=</span> 22 <span class="nv">val</span><span class="o">=</span>LiveBarEvent<span class="o">(</span><span class="nv">barDuration</span><span class="o">=</span>MINUTES, <span class="nv">createTimestamp</span><span class="o">=</span>1437139378855, <span class="nv">instrument</span><span class="o">=</span>APPL, <span class="nv">price</span><span class="o">=</span>122.080<span class="o">)</span>
</pre></div>


<h3>La prochainne fois  (Partie 2 utiliser les operateurs de multi-threading  observeOn pour executer le code de maniere concurente )</h3>

                <div class="clear"></div>
                <div class="info">
                    <a href="http://dsebban.github.io/blog/fr/2015/rxjava-in-action-with-live-financial-market-data-from-ib-part-1.html">posted at 22:20</a>&nbsp;&middot;&nbsp;<a href="http://dsebban.github.io/blog/fr/category/java.html" rel="tag">Java</a>&nbsp;&middot;&nbsp;<a href="http://dsebban.github.io/blog/fr/tag/java.html" class="tags">java</a>&nbsp;<a href="http://dsebban.github.io/blog/fr/tag/rxjava.html" class="tags">RxJava</a>&nbsp;<a href="http://dsebban.github.io/blog/fr/tag/finance.html" class="tags">finance</a>
                </div>

            </article>
            <div class="clear"></div>
            <h4 class="date">Feb 06, 2014</h4>
            <article class="post">
<h2 class="title">
                    <a href="http://dsebban.github.io/blog/fr/2014/hello.html" rel="bookmark" title="Permanent Link to &quot;Hello World&quot;">Hello World</a>
                </h2>

                <p>My <em>first</em> post using <a class="reference external" href="http://docs.getpelican.com/en/3.3.0/getting_started.html">Pelican</a>!</p>


                <div class="clear"></div>
                <div class="info">
                    <a href="http://dsebban.github.io/blog/fr/2014/hello.html">posted at 23:24</a>&nbsp;&middot;&nbsp;<a href="http://dsebban.github.io/blog/fr/tag/pelican.html" class="tags">pelican</a>&nbsp;<a href="http://dsebban.github.io/blog/fr/tag/web.html" class="tags">web</a>
                </div>

            </article>
            <div class="clear"></div>
            <div class="clear"></div>
            <footer>
                <p>
                <a href="https://github.com/jody-frankowski/blue-penguin">Blue Penguin</a> Theme
                &middot;
                Powered by <a href="http://getpelican.com">Pelican</a>
                &middot;
                <a href="http://dsebban.github.io/blog/fr/feeds/all.atom.xml" rel="alternate">Atom Feed</a>
            </footer>
        </div>
        <div class="clear"></div>
    </div>
    <script type="text/javascript">
    var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
    document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
    </script>
    <script type="text/javascript">
    try {
        var pageTracker = _gat._getTracker("UA-65283210-1");
    pageTracker._trackPageview();
    } catch(err) {}</script>
</body>
</html>